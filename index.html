<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=0.8, maximum-scale=1.0">
    <title>Nutrition Warfare</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            transition: all 0.3s ease;
        }

        :root {
            --primary: #4CAF50;
            --primary-light: #8BC34A;
            --secondary: #FF9800;
            --secondary-light: #FFC107;
            --tertiary: #2196F3;
            --tertiary-light: #03A9F4;
            --danger: #F44336;
            --light: #F9F9F9;
            --dark: #333;
            --shadow: 0 4px 8px rgba(0,0,0,0.1);
            --radius: 12px;
            --font-kid: 'Comic Neue', 'Comic Sans MS', cursive, sans-serif;
            --font-readable: 'Fredoka One', 'Segoe UI', sans-serif;
        }

        body {
            font-family: var(--font-kid);
            color: var(--dark);
            min-height: 100vh;
            padding: 15px;
            max-width: 1200px;
            margin: 0 auto;
            position: relative;
            overflow-x: hidden;
            background-color: #f0f9ff;
            transform: scale(0.95);
            transform-origin: top center;
        }

        /* Animated Apple Background */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 400%;
            height: 400%;
            background-image: url('apple.png');
            background-size: 120px 120px;
            opacity: 0.15;
            z-index: -1;
            animation: moveBackground 40s linear infinite;
            pointer-events: none;
        }

        @keyframes moveBackground {
            0% {
                transform: translate(0, 0);
            }
            100% {
                transform: translate(-100px, -100px);
            }
        }

        /* Loading Screen */
        #loadingScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--primary) 0%, var(--tertiary) 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            text-align: center;
            color: white;
        }

        .loading-content {
            padding: 40px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            color: var(--dark);
            max-width: 400px;
            width: 90%;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 6px solid var(--light);
            border-top: 6px solid var(--primary);
            border-radius: 50%;
            animation: spin 1.5s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-dots {
            display: inline-block;
            animation: dots 1.5s infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }

        header {
            text-align: center;
            padding: 15px;
            background: linear-gradient(90deg, var(--primary), var(--tertiary));
            border-radius: var(--radius);
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            color: white;
            border: 6px solid white;
            position: relative;
            z-index: 1;
        }

        #musicControls {
            position: fixed;
            top: 15px;
            right: 15px;
            z-index: 1000;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: var(--shadow);
            border: 2px solid white;
            transition: transform 0.3s ease;
            font-size: 1.2rem;
        }

        #musicControls:hover {
            transform: scale(1.1) rotate(10deg);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        }

        h1 {
            font-family: var(--font-readable);
            font-size: 2.8rem;
            text-shadow: 3px 3px 0 var(--secondary);
            margin-bottom: 8px;
            letter-spacing: 0.5px;
            transition: transform 0.3s ease;
        }

        h1:hover {
            transform: scale(1.02);
        }

        .age-range {
            font-size: 1.5rem;
            background: var(--secondary);
            display: inline-block;
            padding: 6px 20px;
            border-radius: 40px;
            font-weight: bold;
            transform: rotate(-5deg);
            box-shadow: 3px 3px 0 rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }

        .age-range:hover {
            transform: rotate(0deg) scale(1.05);
        }

        .config-btn {
            width: 45px;
            height: 45px;
            border: none;
            border-radius: 50%;
            font-size: 1.3rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            box-shadow: 0 4px 0 rgba(0,0,0,0.2);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .config-btn:hover {
            transform: translateY(-3px) scale(1.1);
            box-shadow: 0 6px 0 rgba(0,0,0,0.2);
        }

        .config-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: 0 4px 0 rgba(0,0,0,0.2);
        }

        .preset-btn {
            padding: 6px 10px;
            background: white;
            border: 2px solid var(--primary-light);
            border-radius: 6px;
            font-family: var(--font-kid);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            color: var(--dark);
            margin: 0 2px;
        }

        .preset-btn:hover {
            background: var(--primary-light);
            color: white;
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .preset-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            transform: scale(1.1);
            box-shadow: 0 4px 8px rgba(76, 175, 80, 0.3);
        }

        .player-inputs-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 12px;
            margin-top: 15px;
        }

        .player-input-wrapper {
            position: relative;
            transition: all 0.3s ease;
        }

        .player-input-wrapper:hover {
            transform: translateY(-3px);
        }

        .player-input-label {
            display: block;
            margin-bottom: 4px;
            font-weight: bold;
            color: var(--dark);
            font-size: 0.9rem;
            transition: color 0.3s ease;
        }

        .player-input {
            width: 100%;
            padding: 12px;
            border: 3px solid var(--primary-light);
            border-radius: 8px;
            font-size: 1.1rem;
            font-family: var(--font-kid);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            background: white;
        }

        .player-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.2);
            transform: scale(1.02);
        }

        .color-picker {
            display: flex;
            gap: 5px;
            margin-top: 6px;
            flex-wrap: wrap;
            justify-content: center;
            padding: 4px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 6px;
            transition: all 0.3s ease;
        }

        .color-picker:hover {
            background: rgba(255, 255, 255, 0.8);
        }

        .color-option {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
        }

        .color-option:hover {
            transform: scale(1.3);
            box-shadow: 0 0 8px rgba(0,0,0,0.3);
        }

        .color-option.selected {
            border-color: #333;
            transform: scale(1.3);
            box-shadow: 0 0 0 2px white, 0 0 0 4px currentColor;
        }

        .color-option.selected::after {
            content: '‚úì';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 0.7rem;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }

        .game-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .board-section {
            flex: 3;
            min-width: 280px;
            transition: all 0.3s ease;
        }

        .info-section {
            flex: 1;
            min-width: 280px;
            transition: all 0.3s ease;
        }

        #gameBoard {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(5px);
            border-radius: var(--radius);
            padding: 20px;
            box-shadow: var(--shadow);
            border: 4px solid var(--primary);
            position: relative;
            min-height: 500px;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        #gameBoard:hover {
            box-shadow: 0 8px 16px rgba(0,0,0,0.15);
        }

        .board-path {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            grid-auto-rows: 75px;
            gap: 10px;
            position: relative;
            transition: all 0.3s ease;
        }

        .tile {
            background: var(--light);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 3px solid transparent;
            text-align: center;
            padding: 8px;
            position: relative;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.1);
            overflow: visible;
        }

        .tile:hover {
            transform: scale(1.05) rotate(2deg);
            z-index: 100;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
        }

        .tile-tooltip {
            position: absolute;
            bottom: calc(100% + 10px);
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 0.8rem;
            white-space: nowrap;
            z-index: 1000;
            pointer-events: none;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .tile:hover .tile-tooltip {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(0);
        }

        .tile::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.1);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .tile:hover::before {
            opacity: 1;
        }

        .tile-icon {
            font-size: 1.5rem;
            margin-bottom: 3px;
            transition: transform 0.3s ease;
        }

        .tile:hover .tile-icon {
            transform: scale(1.2);
        }

        .tile-number {
            position: absolute;
            top: 4px;
            left: 4px;
            font-size: 0.7rem;
            color: #666;
            background: rgba(255,255,255,0.8);
            padding: 1px 4px;
            border-radius: 3px;
            transition: all 0.3s ease;
        }

        .tile:hover .tile-number {
            background: rgba(255,255,255,0.95);
            transform: scale(1.1);
        }

        .tile-name {
            font-size: 0.7rem;
            margin-top: 2px;
            color: #555;
            font-weight: normal;
        }

        .tile-question { background: #E8F5E9; border-color: var(--primary); }
        .tile-exercise { background: #E3F2FD; border-color: var(--tertiary); }
        .tile-fact { background: #FCE4EC; border-color: #E91E63; }
        .tile-empty { background: #F5F5F5; border-color: #9E9E9E; opacity: 0.9; }
        .tile-start { background: #C8E6C9; border-color: #2E7D32; }
        .tile-finish { background: linear-gradient(45deg, #FFEB3B, #FF9800); border-color: #FF5722; }

        .player-token {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            position: absolute;
            border: 2px solid white;
            box-shadow: 0 0 5px rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 0.7rem;
            z-index: 5;
            transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .player-info {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(5px);
            border-radius: var(--radius);
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            border: 4px solid var(--secondary-light);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .player-info:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.15);
        }

        .player-info h2 {
            color: var(--secondary);
            margin-bottom: 12px;
            font-size: 1.6rem;
            transition: color 0.3s ease;
        }

        .players-container {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }

        .player-card {
            flex: 1;
            min-width: 110px;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            font-weight: bold;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            overflow: hidden;
        }

        .player-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s ease;
        }

        .player-card:hover::before {
            left: 100%;
        }

        .player-card.active {
            transform: scale(1.05) rotate(1deg);
            box-shadow: 0 0 20px rgba(255, 152, 0, 0.5);
            animation: activePulse 1.5s infinite;
        }

        @keyframes activePulse {
            0%, 100% { box-shadow: 0 0 15px rgba(255, 152, 0, 0.5); }
            50% { box-shadow: 0 0 25px rgba(255, 152, 0, 0.8); }
        }

        .player-name {
            font-size: 1.1rem;
            margin-bottom: 4px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
            transition: transform 0.3s ease;
        }

        .player-card:hover .player-name {
            transform: scale(1.1);
        }

        .player-score {
            font-size: 1.8rem;
            color: inherit;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            transition: transform 0.3s ease;
        }

        .player-card:hover .player-score {
            transform: scale(1.2);
        }

        .controls {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 15px;
            transition: all 0.3s ease;
        }

        .btn {
            padding: 15px 20px;
            border: none;
            border-radius: 40px;
            font-family: var(--font-readable);
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 4px 0 rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s ease;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 6px 0 rgba(0,0,0,0.2);
        }

        .btn:active {
            transform: translateY(1px) scale(0.95);
            box-shadow: 0 2px 0 rgba(0,0,0,0.2);
        }

        .btn-roll {
            background: linear-gradient(to right, var(--primary), var(--primary-light));
            color: white;
        }

        .btn-new {
            background: linear-gradient(to right, var(--tertiary), var(--tertiary-light));
            color: white;
        }

        .dice-result {
            font-size: 3rem;
            text-align: center;
            margin: 15px 0;
            animation: pop 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            transition: all 0.3s ease;
        }

        @keyframes pop {
            0% { transform: scale(0.5) rotate(-180deg); opacity: 0; }
            70% { transform: scale(1.2) rotate(10deg); }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }

        .question-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(5px);
            border-radius: var(--radius);
            padding: 20px;
            box-shadow: var(--shadow);
            border: 4px solid var(--primary);
            margin-top: 20px;
            display: none;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .question-panel.active {
            display: block;
            animation: slideIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px) scale(0.9); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        .question-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
            color: var(--primary);
            transition: all 0.3s ease;
        }

        .question-icon {
            font-size: 2rem;
            transition: transform 0.3s ease;
        }

        .question-panel:hover .question-icon {
            transform: rotate(10deg) scale(1.1);
        }

        .question-text {
            font-size: 1.4rem;
            line-height: 1.4;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .options-container {
            display: grid;
            gap: 12px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .option-btn {
            padding: 15px;
            background: #F5F5F5;
            border: 3px solid #E0E0E0;
            border-radius: 12px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            text-align: left;
            font-family: var(--font-kid);
            position: relative;
            overflow: hidden;
        }

        .option-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s ease;
        }

        .option-btn:hover::before {
            left: 100%;
        }

        .option-btn:hover {
            background: #E8F5E9;
            border-color: var(--primary-light);
            transform: translateX(10px) scale(1.02);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .option-btn.correct {
            background: #C8E6C9;
            border-color: var(--primary);
            color: #1B5E20;
            animation: correctPulse 0.5s ease;
        }

        @keyframes correctPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .option-btn.incorrect {
            background: #FFCDD2;
            border-color: var(--danger);
            color: #B71C1C;
            animation: shake 0.5s ease;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .feedback {
            padding: 15px;
            background: #E3F2FD;
            border-radius: 12px;
            margin-top: 15px;
            display: none;
            font-size: 1.2rem;
            line-height: 1.5;
            border-left: 6px solid var(--tertiary);
            transition: all 0.3s ease;
        }

        .feedback.show {
            display: block;
            animation: fadeIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .rules-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(5px);
            border-radius: var(--radius);
            padding: 20px;
            box-shadow: var(--shadow);
            border: 4px solid var(--tertiary-light);
            margin-top: 20px;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .rules-section:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.15);
        }

        .rules-section h2 {
            color: var(--tertiary);
            margin-bottom: 15px;
            font-size: 1.8rem;
            transition: color 0.3s ease;
        }

        .rules-section:hover h2 {
            color: var(--tertiary-light);
        }

        .nutrient-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: bold;
            margin: 4px;
            font-size: 0.8rem;
            transition: all 0.3s ease;
        }

        .nutrient-badge:hover {
            transform: translateY(-3px) scale(1.1);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .nutrient-1 { background: #FFECB3; color: #FF6F00; }
        .nutrient-2 { background: #C8E6C9; color: #1B5E20; }
        .nutrient-3 { background: #BBDEFB; color: #0D47A1; }
        .nutrient-4 { background: #F8BBD0; color: #880E4F; }
        .nutrient-5 { background: #E1BEE7; color: #4A148C; }
        .nutrient-6 { background: #FFCCBC; color: #BF360C; }
        .nutrient-7 { background: #B2DFDB; color: #004D40; }

        #startScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--primary) 0%, var(--tertiary) 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 15px;
            text-align: center;
            color: white;
            overflow-y: auto;
            transition: all 0.3s ease;
        }

        .start-content {
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: var(--radius);
            max-width: 700px;
            width: 90%;
            box-shadow: var(--shadow);
            color: var(--dark);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            margin: 15px 0;
        }

        .start-content:hover {
            transform: scale(1.02);
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
        }

        .start-content h2 {
            color: var(--primary);
            margin-bottom: 15px;
            font-size: 2rem;
            transition: color 0.3s ease;
        }

        .player-setup {
            margin: 25px 0;
            transition: all 0.3s ease;
        }

        .start-btn {
            background: linear-gradient(to right, #FF9800, #FF5722);
            color: white;
            font-size: 1.5rem;
            padding: 15px 40px;
            margin-top: 25px;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .start-btn:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 6px 0 rgba(0,0,0,0.2);
        }

        #winScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1001;
            color: white;
            text-align: center;
            padding: 15px;
            overflow-y: auto;
            transition: all 0.3s ease;
        }

        .win-content {
            background: linear-gradient(45deg, #FF9800, #FFEB3B);
            padding: 25px;
            border-radius: var(--radius);
            max-width: 800px;
            color: #333;
            animation: celebrate 2s ease infinite;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .win-content:hover {
            transform: scale(1.02);
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }

        @keyframes celebrate {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        .win-content h2 {
            font-size: 3rem;
            margin-bottom: 15px;
            color: #D32F2F;
            transition: color 0.3s ease;
        }

        .nutrition-message {
            font-size: 1.8rem;
            margin: 15px 0;
            color: #1B5E20;
            font-weight: bold;
            padding: 12px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: var(--radius);
            transition: all 0.3s ease;
        }

        .leaderboard-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: var(--radius);
            padding: 20px;
            margin: 20px 0;
            box-shadow: var(--shadow);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .leaderboard-section:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.15);
        }

        .leaderboard-section h3 {
            color: var(--tertiary);
            font-size: 1.8rem;
            margin-bottom: 15px;
            text-align: center;
            transition: color 0.3s ease;
        }

        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
            transition: all 0.3s ease;
        }

        .stat-card {
            background: #F5F5F5;
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            border-left: 6px solid var(--primary);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .stat-card:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        }

        .stat-card h4 {
            color: var(--primary);
            font-size: 1.3rem;
            margin-bottom: 8px;
            transition: color 0.3s ease;
        }

        .stat-value {
            font-size: 2.2rem;
            font-weight: bold;
            color: var(--dark);
            transition: transform 0.3s ease;
        }

        .stat-card:hover .stat-value {
            transform: scale(1.1);
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: var(--radius);
            padding: 15px;
            margin-top: 15px;
            box-shadow: var(--shadow);
            height: 350px;
            transition: all 0.3s ease;
        }

        .chart-container:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.15);
        }

        .turn-message {
            background: rgba(255, 152, 0, 0.1);
            border: 3px solid var(--secondary);
            border-radius: var(--radius);
            padding: 12px;
            margin: 12px 0;
            text-align: center;
            font-size: 1.2rem;
            color: var(--dark);
            animation: messagePulse 2s infinite;
            opacity: 1;
            transition: opacity 1s ease, transform 0.3s ease;
        }

        .turn-message.fade-out {
            opacity: 0;
            transform: translateY(-20px);
        }

        @keyframes messagePulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        .advanced-settings-toggle {
            background: var(--tertiary);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: var(--radius);
            font-family: var(--font-kid);
            font-size: 0.9rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            margin: 12px auto;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            width: 180px;
        }

        .advanced-settings-toggle:hover {
            background: var(--tertiary-light);
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .advanced-settings-toggle .arrow {
            transition: transform 0.3s ease;
        }

        .advanced-settings-toggle.expanded .arrow {
            transform: rotate(180deg);
        }

        .advanced-settings-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            background: rgba(232, 245, 233, 0.5);
            border-radius: var(--radius);
            margin-top: 8px;
        }

        .advanced-settings-content.expanded {
            max-height: 280px;
            padding: 12px;
        }

        .board-size-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }

        .board-presets {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 8px;
        }

        @media (max-width: 768px) {
            body {
                transform: scale(0.9);
                padding: 10px;
            }
            
            .game-container {
                flex-direction: column;
                gap: 15px;
            }
            
            .board-path {
                grid-template-columns: repeat(6, 1fr);
                grid-auto-rows: 65px;
            }
            
            h1 {
                font-size: 2.2rem;
            }
            
            .start-content {
                padding: 20px;
            }
            
            .board-size-controls {
                flex-direction: column;
                gap: 8px;
            }
            
            .tile {
                font-size: 0.8rem;
            }
            
            .tile-icon {
                font-size: 1.2rem;
            }
            
            .btn {
                padding: 12px 16px;
                font-size: 1.1rem;
            }
            
            .start-btn {
                font-size: 1.3rem;
                padding: 12px 30px;
            }
            
            .tile-name {
                font-size: 0.65rem;
            }
        }

        @media (max-width: 480px) {
            body {
                transform: scale(0.85);
                padding: 8px;
            }
            
            .board-path {
                grid-template-columns: repeat(4, 1fr);
                grid-auto-rows: 60px;
            }
            
            .player-inputs-container {
                grid-template-columns: 1fr;
            }
            
            .player-card {
                min-width: 90px;
            }
            
            .tile {
                font-size: 0.7rem;
            }
            
            .tile-icon {
                font-size: 1rem;
            }
            
            .btn {
                padding: 10px 14px;
                font-size: 1rem;
            }
            
            .start-btn {
                font-size: 1.2rem;
                padding: 10px 25px;
            }
            
            .tile-name {
                font-size: 0.6rem;
            }
            
            h1 {
                font-size: 1.8rem;
            }
            
            .age-range {
                font-size: 1.2rem;
            }
        }

        @media (max-width: 320px) {
            body {
                transform: scale(0.8);
            }
        }

        /* Smooth transitions for all elements */
        div, section, article, header, footer, main, aside, 
        button, input, select, textarea, img, canvas {
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        /* Remove scrollbar for cleaner look */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-light);
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Comic+Neue:wght@400;700&family=Fredoka+One&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <!-- Loading Screen -->
    <div id="loadingScreen">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <h2 style="color: var(--primary); margin-bottom: 10px;">Loading Nutrition Adventure<span class="loading-dots"></span></h2>
            <p style="color: #666; margin-bottom: 15px;">Loading game data and resources</p>
            <div style="display: flex; align-items: center; justify-content: center; gap: 10px; margin-top: 20px;">
                <div style="width: 20px; height: 20px; background: var(--primary); border-radius: 50%; animation: bounce 1s infinite;"></div>
                <div style="width: 20px; height: 20px; background: var(--secondary); border-radius: 50%; animation: bounce 1s infinite 0.2s;"></div>
                <div style="width: 20px; height: 20px; background: var(--tertiary); border-radius: 50%; animation: bounce 1s infinite 0.4s;"></div>
            </div>
        </div>
    </div>

    <!-- Start Screen -->
    <div id="startScreen" style="display: none;">
        <div class="start-content">
            <h1>Nutrition Warfare</h1>
            <div class="age-range">Ages 9-11</div>
            
            <div style="margin: 8px 0; padding: 8px; background: rgba(76, 175, 80, 0.1); border-radius: 8px; font-size: 0.9rem; color: #4CAF50; border: 2px solid rgba(76, 175, 80, 0.3);">
                <i class="fas fa-music"></i> Background music can be toggled from the top right corner!
            </div>
            
            <h2>Welcome to the Healthy Eating Adventure!</h2>
            <p style="font-size: 1.1rem; margin: 15px 0; line-height: 1.5;">
                Journey through the land of nutrition, learn about healthy foods, and discover the power of the 7 nutrients! 
                Answer questions, complete challenges, and be the first to reach the finish line.
            </p>
            
            <!-- Game Configuration Section -->
            <div class="configuration-section" style="margin: 25px 0; padding: 20px; background: rgba(249, 249, 249, 0.9); border-radius: 12px; border: 3px solid var(--primary-light);">
                <h3 style="color: var(--primary); margin-bottom: 20px; font-size: 1.6rem;">
                    <i class="fas fa-cogs"></i> Game Configuration
                </h3>
                
                <!-- Player Configuration -->
                <div class="config-group" style="margin-bottom: 25px;">
                    <h4 style="color: var(--secondary); margin-bottom: 12px; font-size: 1.2rem;">
                        <i class="fas fa-users"></i> Player Setup
                    </h4>
                    <div class="player-setup">
                        <div style="display: flex; align-items: center; justify-content: center; gap: 15px; margin-bottom: 15px;">
                            <button class="config-btn minus-btn" id="removePlayerBtn" style="background: var(--danger);">
                                <i class="fas fa-minus"></i>
                            </button>
                            <span style="font-size: 1.2rem; font-weight: bold; min-width: 90px; text-align: center;" id="playerCountDisplay">2 Players</span>
                            <button class="config-btn plus-btn" id="addPlayerBtn" style="background: var(--primary);">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                        
                        <div class="player-inputs-container" id="playerInputsContainer">
                            <!-- Dynamic player inputs will be inserted here -->
                        </div>
                    </div>
                </div>
                
                <!-- Advanced Settings Toggle -->
                <button class="advanced-settings-toggle" id="advancedSettingsToggle">
                    <span>Advanced Settings</span>
                    <span class="arrow"><i class="fas fa-chevron-down"></i></span>
                </button>
                
                <!-- Advanced Settings Content -->
                <div class="advanced-settings-content" id="advancedSettingsContent">
                    <h4 style="color: var(--tertiary); margin-bottom: 12px; font-size: 1.1rem;">
                        <i class="fas fa-sliders-h"></i> Board Configuration
                    </h4>
                    
                    <div class="board-size-controls">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <button class="config-btn minus-btn" id="removeTileBtn" style="background: var(--danger);">
                                <i class="fas fa-minus"></i>
                            </button>
                            <span style="font-size: 1.1rem; font-weight: bold; min-width: 110px; text-align: center;" id="tileCountDisplay">30 Spaces</span>
                            <button class="config-btn plus-btn" id="addTileBtn" style="background: var(--primary);">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                        
                        <div class="board-presets">
                            <button class="preset-btn" data-tiles="20">Short (20)</button>
                            <button class="preset-btn active" data-tiles="30">Standard (30)</button>
                            <button class="preset-btn" data-tiles="45">Long (45)</button>
                            <button class="preset-btn" data-tiles="67">Epic (67)</button>
                        </div>
                    </div>
                    
                    <div style="margin-top: 12px; padding: 8px; background: rgba(232, 245, 233, 0.8); border-radius: 6px; border-left: 4px solid var(--primary);">
                        <p style="font-size: 0.8rem; color: #1b5e20; margin: 0;">
                            <i class="fas fa-info-circle"></i> Larger boards have more spaces but also bigger rewards and penalties!
                        </p>
                    </div>
                </div>
            </div>
            
            <button class="btn start-btn" id="startGameBtn">
                <i class="fas fa-play-circle"></i> Start Adventure!
            </button>
        </div>
    </div>

    <!-- Main Game Interface -->
    <header>
        <h1>Nutrition Warfare</h1>
        <div class="age-range">Ages 9-11</div>
    </header>
    
    <div class="game-container">
        <div class="board-section">
            <div id="gameBoard">
                <div id="turnMessage" class="turn-message" style="display: none;"></div>
                
                <div class="board-path" id="boardPath">
                    <!-- Tiles will be generated by JavaScript -->
                </div>
                
                <div class="dice-result" id="diceResult" style="display: none;"></div>
                
                <div class="question-panel" id="questionPanel">
                    <div class="question-header">
                        <div class="question-icon" id="questionIcon">‚ùì</div>
                        <h2 id="questionType">Nutrition Question</h2>
                    </div>
                    <div class="question-text" id="questionText"></div>
                    
                    <div class="options-container" id="optionsContainer"></div>
                    
                    <div class="feedback" id="feedback"></div>
                </div>
            </div>
        </div>
        
        <div class="info-section">
            <div class="player-info">
                <h2><i class="fas fa-users"></i> Players</h2>
                <div class="players-container" id="playersContainer"></div>
                
                <div class="controls">
                    <button class="btn btn-roll" id="rollBtn">
                        <i class="fas fa-dice"></i> Roll & Move!
                    </button>
                    <button class="btn btn-new" id="newGameBtn">
                        <i class="fas fa-redo"></i> New Game
                    </button>
                </div>
            </div>
            
            <div class="rules-section">
                <h2><i class="fas fa-book"></i> How to Play</h2>
                <div class="rules-content">
                    <p><strong>Goal:</strong> Be the first player to reach the finish line by answering nutrition questions and completing challenges!</p>
                    
                    <ul style="padding-left: 20px; margin: 10px 0;">
                        <li style="margin-bottom: 8px;"><strong>Roll the dice</strong> on your turn to move forward.</li>
                        <li style="margin-bottom: 8px;"><strong>Different tile colors mean different actions:</strong>
                            <br>üíö <strong>Green:</strong> Nutrition Question
                            <br>üíô <strong>Blue:</strong> Exercise Challenge
                            <br>üíñ <strong>Pink:</strong> Healthy Fact
                            <br>‚ö™ <strong>White:</strong> Rest Space (no action)
                        </li>
                        <li style="margin-bottom: 8px;"><strong>Answer questions correctly</strong> to earn extra moves!</li>
                        <li style="margin-bottom: 8px;"><strong>Learn about the 7 nutrients:</strong>
                            <span class="nutrient-badge nutrient-1">Carbs</span>
                            <span class="nutrient-badge nutrient-2">Protein</span>
                            <span class="nutrient-badge nutrient-3">Fats</span>
                            <span class="nutrient-badge nutrient-4">Vitamins</span>
                            <span class="nutrient-badge nutrient-5">Minerals</span>
                            <span class="nutrient-badge nutrient-6">Water</span>
                            <span class="nutrient-badge nutrient-7">Fiber</span>
                        </li>
                        <li><strong>Remember:</strong> A balanced diet includes foods from all food groups!</li>
                    </ul>
                    
                    <p><strong>Winning:</strong> First player to reach the finish line wins! But everyone learns about healthy eating.</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Win Screen -->
    <div id="winScreen">
        <div class="win-content">
            <h2><i class="fas fa-trophy"></i> Congratulations!</h2>
            <div id="winnerMessage" style="font-size: 2.2rem; margin: 15px 0;"></div>
            <div class="nutrition-message" id="nutritionMessage"></div>
            
            <!-- Leaderboard Section -->
            <div class="leaderboard-section">
                <h3><i class="fas fa-chart-line"></i> Game Statistics</h3>
                
                <div class="stats-container" id="statsContainer">
                    <!-- Stats will be inserted here -->
                </div>
                
                <div class="chart-container">
                    <canvas id="scoreChart"></canvas>
                </div>
            </div>
            
            <button class="btn start-btn" id="playAgainBtn" style="margin-top: 15px;">
                <i class="fas fa-redo"></i> Play Again
            </button>
        </div>
    </div>

    <script>
        // ============================================
        // GAME CONFIGURATION & DATA
        // ============================================
        
        // Game configuration
        const CONFIG = {
            diceSides: 6,
            startTile: 0,
            initialScore: 0
        };
        
        // The 7 nutrients for reference throughout the game
        const NUTRIENTS = [
            { name: "Carbohydrates", function: "Provide energy for your body", emoji: "üçû", color: "nutrient-1", examples: ["Whole grain bread", "Rice", "Pasta", "Fruits"] },
            { name: "Proteins", function: "Build and repair muscles and tissues", emoji: "üçó", color: "nutrient-2", examples: ["Chicken", "Fish", "Eggs", "Beans"] },
            { name: "Fats", function: "Store energy and protect organs", emoji: "ü•ë", color: "nutrient-3", examples: ["Avocado", "Nuts", "Olive oil", "Cheese"] },
            { name: "Vitamins", function: "Help your body work properly and fight illness", emoji: "ü•¶", color: "nutrient-4", examples: ["Broccoli", "Oranges", "Carrots", "Spinach"] },
            { name: "Minerals", function: "Build strong bones and teeth", emoji: "ü•õ", color: "nutrient-5", examples: ["Milk", "Yogurt", "Bananas", "Leafy greens"] },
            { name: "Water", function: "Hydrates your body and helps digestion", emoji: "üíß", color: "nutrient-6", examples: ["Water", "Cucumber", "Watermelon", "Soup"] },
            { name: "Fiber", function: "Helps digestion and keeps you full", emoji: "üåæ", color: "nutrient-7", examples: ["Whole grains", "Apples", "Beans", "Berries"] }
        ];
        
        // Tile types configuration
        const TILE_TYPES = {
            QUESTION: { 
                name: "Question", 
                emoji: "‚ùì", 
                color: "tile-question", 
                description: "Answer a nutrition question correctly to earn extra moves!" 
            },
            EXERCISE: { 
                name: "Exercise", 
                emoji: "üèÉ", 
                color: "tile-exercise", 
                description: "Complete a fun exercise challenge!" 
            },
            FACT: { 
                name: "Fact", 
                emoji: "üí°", 
                color: "tile-fact", 
                description: "Learn an interesting health fact!" 
            },
            EMPTY: { 
                name: "Rest", 
                emoji: "üòå", 
                color: "tile-empty", 
                description: "Take a break and rest on this space." 
            },
            START: { 
                name: "Start", 
                emoji: "üöÄ", 
                color: "tile-start", 
                description: "Begin your nutrition adventure here!" 
            },
            FINISH: { 
                name: "Finish", 
                emoji: "üèÜ", 
                color: "tile-finish", 
                description: "Complete your journey to win the game!" 
            }
        };
        
        // Game state & variables
        let gameState = {
            players: [],
            currentPlayerIndex: 0,
            gameActive: false,
            tiles: [],
            diceValue: 0,
            questionActive: false,
            isRolling: false,
            lastRandomSeed: Date.now()
        };
        
        // Player configuration
        const MIN_PLAYERS = 2;
        const MAX_PLAYERS = 4;
        let currentPlayerCount = 2;
        
        // Board configuration
        let currentTileCount = 30;
        
        // All player colors (8 colors for all players to choose from)
        const PLAYER_COLORS = [
            { name: 'Green', value: '#4CAF50', class: 'player-1' },
            { name: 'Orange', value: '#FF9800', class: 'player-2' },
            { name: 'Blue', value: '#2196F3', class: 'player-3' },
            { name: 'Purple', value: '#9C27B0', class: 'player-4' },
            { name: 'Red', value: '#F44336', class: 'player-5' },
            { name: 'Yellow', value: '#FFEB3B', class: 'player-6', textColor: '#333' },
            { name: 'Teal', value: '#009688', class: 'player-7' },
            { name: 'Pink', value: '#E91E63', class: 'player-8' }
        ];
        
        // Player positions on tile (4 corners)
        const TOKEN_POSITIONS = [
            { top: '4px', left: '4px' },
            { top: '4px', right: '4px' },
            { bottom: '4px', left: '4px' },
            { bottom: '4px', right: '4px' }
        ];
        
        // Notification system
        let notificationTimeout = null;
        let externalDataLoaded = false;
        let dataLoadAttempts = 0;
        const MAX_DATA_LOAD_ATTEMPTS = 5;
        
        // ============================================
        // DOM ELEMENTS
        // ============================================
        let startScreen, winScreen, gameBoard, boardPath, playersContainer, diceResult, 
            questionPanel, questionText, questionIcon, questionType, optionsContainer, 
            feedback, rollBtn, newGameBtn, startGameBtn, playAgainBtn, winnerMessage, 
            nutritionMessage, statsContainer, turnMessage, tileCountDisplay,
            advancedSettingsToggle, advancedSettingsContent, addTileBtn, removeTileBtn,
            loadingScreen;
        
        // ============================================
        // LOADING SCREEN FUNCTIONS
        // ============================================
        
        function showLoadingScreen() {
            if (loadingScreen) {
                loadingScreen.style.display = 'flex';
            }
        }
        
        function hideLoadingScreen() {
            if (loadingScreen) {
                loadingScreen.style.opacity = '0';
                setTimeout(() => {
                    loadingScreen.style.display = 'none';
                    loadingScreen.style.opacity = '1';
                    if (startScreen) {
                        startScreen.style.display = 'flex';
                    }
                }, 500);
            }
        }
        
        function updateLoadingMessage(message) {
            const loadingDots = document.querySelector('.loading-dots');
            if (loadingDots) {
                loadingDots.parentElement.querySelector('p').textContent = message;
            }
        }
        
        // ============================================
        // EXTERNAL DATA LOADING
        // ============================================
        
        function loadExternalData() {
            updateLoadingMessage("Loading game data...");
            
            // Check if external data is already loaded
            if (typeof QUESTIONS !== 'undefined' && 
                typeof FACTS !== 'undefined' && 
                typeof EXERCISE_CHALLENGES !== 'undefined' && 
                typeof WIN_MESSAGES !== 'undefined') {
                
                externalDataLoaded = true;
                console.log("External data already loaded!");
                hideLoadingScreen();
                return;
            }
            
            // Try to load the external data file
            const script = document.createElement('script');
            script.src = 'nutriquest-data.js';
            script.onload = function() {
                dataLoadAttempts = 0;
                if (typeof QUESTIONS !== 'undefined' && 
                    typeof FACTS !== 'undefined' && 
                    typeof EXERCISE_CHALLENGES !== 'undefined' && 
                    typeof WIN_MESSAGES !== 'undefined') {
                    
                    externalDataLoaded = true;
                    console.log("External data loaded successfully!");
                    updateLoadingMessage("Data loaded successfully!");
                    
                    // Add a small delay to show the success message
                    setTimeout(() => {
                        hideLoadingScreen();
                    }, 1000);
                } else {
                    console.warn("External data file loaded but variables are missing.");
                    createFallbackData();
                    hideLoadingScreen();
                }
            };
            
            script.onerror = function() {
                dataLoadAttempts++;
                if (dataLoadAttempts < MAX_DATA_LOAD_ATTEMPTS) {
                    console.warn(`Failed to load external data. Attempt ${dataLoadAttempts} of ${MAX_DATA_LOAD_ATTEMPTS}. Retrying...`);
                    updateLoadingMessage(`Loading data (attempt ${dataLoadAttempts})...`);
                    
                    // Retry after a delay
                    setTimeout(() => {
                        loadExternalData();
                    }, 2000);
                } else {
                    console.error("Failed to load external data after multiple attempts. Using fallback data.");
                    updateLoadingMessage("Using fallback data...");
                    createFallbackData();
                    
                    setTimeout(() => {
                        hideLoadingScreen();
                    }, 1500);
                }
            };
            
            document.head.appendChild(script);
        }
        
        function createFallbackData() {
            updateLoadingMessage("Creating fallback data...");
            
            // Create comprehensive fallback data
            window.QUESTIONS = window.QUESTIONS || [
                {
                    question: "Which food group gives you the most energy?",
                    options: ["Fruits", "Vegetables", "Carbohydrates", "Protein"],
                    correct: 2,
                    feedback: "Correct! Carbohydrates are your body's main source of energy!",
                    icon: "üçû"
                },
                {
                    question: "What nutrient helps build and repair muscles?",
                    options: ["Carbohydrates", "Protein", "Fats", "Vitamins"],
                    correct: 1,
                    feedback: "Great job! Protein is essential for building and repairing muscles!",
                    icon: "üçó"
                },
                {
                    question: "Which of these is a good source of Vitamin C?",
                    options: ["Bread", "Orange", "Cheese", "Rice"],
                    correct: 1,
                    feedback: "Excellent! Oranges are packed with Vitamin C which helps your immune system!",
                    icon: "üçä"
                },
                {
                    question: "What should you drink plenty of every day to stay hydrated?",
                    options: ["Soda", "Water", "Juice", "Milk"],
                    correct: 1,
                    feedback: "Perfect! Water is essential for keeping your body hydrated and healthy!",
                    icon: "üíß"
                },
                {
                    question: "Which food is a good source of calcium for strong bones?",
                    options: ["Chocolate", "Broccoli", "Yogurt", "Potato"],
                    correct: 2,
                    feedback: "Correct! Yogurt is rich in calcium which helps build strong bones!",
                    icon: "ü•õ"
                },
                {
                    question: "What nutrient helps your body absorb vitamins?",
                    options: ["Carbohydrates", "Fats", "Protein", "Fiber"],
                    correct: 1,
                    feedback: "Great! Fats help your body absorb important vitamins!",
                    icon: "ü•ë"
                }
            ];
            
            window.FACTS = window.FACTS || [
                "Drinking water helps your brain work better!",
                "Eating colorful vegetables gives you different vitamins!",
                "Whole grains give you energy that lasts all day!",
                "Protein helps your muscles grow strong!",
                "Calcium from dairy products makes your bones strong!",
                "Fiber helps your digestive system work properly!",
                "Fruits are nature's candy - sweet and healthy!"
            ];
            
            window.EXERCISE_CHALLENGES = window.EXERCISE_CHALLENGES || [
                "Do 10 jumping jacks to get your blood flowing!",
                "Touch your toes 5 times to stretch your muscles!",
                "Take 5 deep breaths to relax your mind and body!",
                "March in place for 15 seconds to wake up your body!",
                "Do 5 arm circles forward and backward!",
                "Stretch up high and touch the sky for 10 seconds!"
            ];
            
            window.WIN_MESSAGES = window.WIN_MESSAGES || [
                "Congratulations on completing your nutrition adventure!",
                "Great job! Remember to eat a rainbow of fruits and vegetables every day!",
                "You're a nutrition champion! Keep making healthy choices!",
                "Well done! You've learned how to fuel your body with healthy foods!",
                "Amazing! You're now a nutrition expert!"
            ];
            
            externalDataLoaded = true;
        }
        
        // ============================================
        // MUSIC CONTROL
        // ============================================
        
        function createMusicElements() {
            if (!document.getElementById('backgroundMusic')) {
                const audio = document.createElement('audio');
                audio.id = 'backgroundMusic';
                audio.loop = true;
                audio.volume = 0.3;
                const source = document.createElement('source');
                source.src = 'nutritionbgm.wav';
                source.type = 'audio/wav';
                audio.appendChild(source);
                document.body.appendChild(audio);
            }
            
            if (!document.getElementById('musicControls')) {
                const musicControls = document.createElement('div');
                musicControls.id = 'musicControls';
                
                const icon = document.createElement('i');
                icon.id = 'musicIcon';
                icon.className = 'fas fa-volume-mute';
                
                musicControls.appendChild(icon);
                document.body.appendChild(musicControls);
                
                musicControls.addEventListener('click', toggleMusic);
            }
        }
        
        function toggleMusic() {
            const backgroundMusic = document.getElementById('backgroundMusic');
            const musicIcon = document.getElementById('musicIcon');
            
            if (!backgroundMusic || !musicIcon) return;
            
            const isMuted = musicIcon.className.includes('fa-volume-mute');
            
            if (isMuted) {
                backgroundMusic.play().catch(e => {
                    console.log("Could not play music:", e);
                });
                musicIcon.className = 'fas fa-volume-up';
            } else {
                backgroundMusic.pause();
                musicIcon.className = 'fas fa-volume-mute';
            }
            
            localStorage.setItem('nutritionMusicMuted', (!isMuted).toString());
        }
        
        // ============================================
        // DYNAMIC PLAYER & BOARD CONFIGURATION
        // ============================================
        
        function initializeConfiguration() {
            updatePlayerCountDisplay();
            renderPlayerInputs();
            updateTileCountDisplay();
            updateConfigurationButtons();
            
            document.getElementById('addPlayerBtn').addEventListener('click', addPlayer);
            document.getElementById('removePlayerBtn').addEventListener('click', removePlayer);
            addTileBtn = document.getElementById('addTileBtn');
            removeTileBtn = document.getElementById('removeTileBtn');
            tileCountDisplay = document.getElementById('tileCountDisplay');
            
            if (addTileBtn) addTileBtn.addEventListener('click', addTile);
            if (removeTileBtn) removeTileBtn.addEventListener('click', removeTile);
            
            // Advanced settings toggle
            advancedSettingsToggle = document.getElementById('advancedSettingsToggle');
            advancedSettingsContent = document.getElementById('advancedSettingsContent');
            
            if (advancedSettingsToggle) {
                advancedSettingsToggle.addEventListener('click', function() {
                    const isExpanded = advancedSettingsContent.classList.contains('expanded');
                    if (isExpanded) {
                        advancedSettingsContent.classList.remove('expanded');
                        advancedSettingsToggle.classList.remove('expanded');
                    } else {
                        advancedSettingsContent.classList.add('expanded');
                        advancedSettingsToggle.classList.add('expanded');
                    }
                });
            }
            
            // Preset buttons
            document.querySelectorAll('.preset-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const tiles = parseInt(this.dataset.tiles);
                    setTileCount(tiles);
                    
                    document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                });
            });
        }
        
        function addPlayer() {
            if (currentPlayerCount < MAX_PLAYERS) {
                currentPlayerCount++;
                updatePlayerCountDisplay();
                renderPlayerInputs();
                updateConfigurationButtons();
            }
        }
        
        function removePlayer() {
            if (currentPlayerCount > MIN_PLAYERS) {
                currentPlayerCount--;
                updatePlayerCountDisplay();
                renderPlayerInputs();
                updateConfigurationButtons();
            }
        }
        
        function updatePlayerCountDisplay() {
            const display = document.getElementById('playerCountDisplay');
            if (display) {
                display.textContent = `${currentPlayerCount} Player${currentPlayerCount > 1 ? 's' : ''}`;
                display.style.transform = 'scale(1.1)';
                setTimeout(() => {
                    display.style.transform = 'scale(1)';
                }, 200);
            }
        }
        
        function renderPlayerInputs() {
            const container = document.getElementById('playerInputsContainer');
            if (!container) return;
            
            container.innerHTML = '';
            
            const defaultNames = ['Player 1', 'Player 2', 'Player 3', 'Player 4'];
            
            for (let i = 0; i < currentPlayerCount; i++) {
                const playerNum = i + 1;
                const defaultColorIndex = i % PLAYER_COLORS.length;
                
                const playerInputHTML = `
                    <div class="player-input-wrapper">
                        <label class="player-input-label">Player ${playerNum}</label>
                        <input type="text" 
                               class="player-input" 
                               id="player${playerNum}Input" 
                               placeholder="Enter name..." 
                               value="${defaultNames[i] || `Player ${playerNum}`}"
                               maxlength="12"
                               style="border-color: ${PLAYER_COLORS[defaultColorIndex].value};">
                        
                        <div class="color-picker">
                            ${PLAYER_COLORS.map((colorOption, index) => `
                                <div class="color-option ${index === defaultColorIndex ? 'selected' : ''}" 
                                     data-player="${playerNum}" 
                                     data-color-index="${index}"
                                     style="background-color: ${colorOption.value};"
                                     title="${colorOption.name}"></div>
                            `).join('')}
                        </div>
                    </div>
                `;
                
                container.innerHTML += playerInputHTML;
            }
            
            // Add event listeners to color pickers
            document.querySelectorAll('.color-option').forEach(option => {
                option.addEventListener('click', function() {
                    const playerNum = parseInt(this.dataset.player);
                    const colorIndex = parseInt(this.dataset.colorIndex);
                    const color = PLAYER_COLORS[colorIndex];
                    
                    // Update input border color
                    const input = document.getElementById(`player${playerNum}Input`);
                    if (input) {
                        input.style.borderColor = color.value;
                        
                        // Update selected state
                        document.querySelectorAll(`.color-option[data-player="${playerNum}"]`).forEach(opt => {
                            opt.classList.remove('selected');
                        });
                        this.classList.add('selected');
                    }
                });
            });
        }
        
        function addTile() {
            if (currentTileCount < 67) {
                currentTileCount = Math.min(currentTileCount + 1, 67);
                updateTileCountDisplay();
                updateConfigurationButtons();
            }
        }
        
        function removeTile() {
            if (currentTileCount > 20) {
                currentTileCount = Math.max(currentTileCount - 1, 20);
                updateTileCountDisplay();
                updateConfigurationButtons();
            }
        }
        
        function setTileCount(count) {
            currentTileCount = Math.max(20, Math.min(count, 67));
            updateTileCountDisplay();
            updateConfigurationButtons();
            
            // Update preset button active states
            document.querySelectorAll('.preset-btn').forEach(btn => {
                const tiles = parseInt(btn.dataset.tiles);
                btn.classList.toggle('active', tiles === currentTileCount);
            });
        }
        
        function updateTileCountDisplay() {
            if (tileCountDisplay) {
                tileCountDisplay.textContent = `${currentTileCount} Space${currentTileCount > 1 ? 's' : ''}`;
                tileCountDisplay.style.transform = 'scale(1.1)';
                setTimeout(() => {
                    tileCountDisplay.style.transform = 'scale(1)';
                }, 200);
            }
        }
        
        function updateConfigurationButtons() {
            // Update player buttons
            const addPlayerBtn = document.getElementById('addPlayerBtn');
            const removePlayerBtn = document.getElementById('removePlayerBtn');
            if (addPlayerBtn) addPlayerBtn.disabled = currentPlayerCount >= MAX_PLAYERS;
            if (removePlayerBtn) removePlayerBtn.disabled = currentPlayerCount <= MIN_PLAYERS;
            
            // Update tile buttons
            if (addTileBtn) addTileBtn.disabled = currentTileCount >= 67;
            if (removeTileBtn) removeTileBtn.disabled = currentTileCount <= 20;
        }
        
        // ============================================
        // GAME INITIALIZATION
        // ============================================
        
        function initGame() {
            // Check if external data is loaded
            if (!externalDataLoaded) {
                showTurnMessage("Game data still loading. Please wait...", 3000);
                return;
            }
            
            // Update CONFIG with chosen tile count
            CONFIG.finishTile = currentTileCount - 1;
            
            // Get player names and colors from inputs
            const players = [];
            const usedColors = new Set();
            
            for (let i = 1; i <= currentPlayerCount; i++) {
                const input = document.getElementById(`player${i}Input`);
                const name = input ? input.value.trim() : `Player ${i}`;
                
                // Get selected color for this player
                const selectedColorOption = document.querySelector(`.color-option[data-player="${i}"].selected`);
                const colorIndex = selectedColorOption ? parseInt(selectedColorOption.dataset.colorIndex) : (i - 1) % PLAYER_COLORS.length;
                const color = PLAYER_COLORS[colorIndex];
                
                // Ensure unique colors
                let finalColorIndex = colorIndex;
                while (usedColors.has(finalColorIndex)) {
                    finalColorIndex = (finalColorIndex + 1) % PLAYER_COLORS.length;
                }
                usedColors.add(finalColorIndex);
                const finalColor = PLAYER_COLORS[finalColorIndex];
                
                players.push({
                    id: i,
                    name: name || `Player ${i}`,
                    position: CONFIG.startTile,
                    score: CONFIG.initialScore,
                    colorClass: finalColor.class,
                    colorValue: finalColor.value,
                    textColor: finalColor.textColor || 'white',
                    positionIndex: i - 1,
                    questionsAnswered: 0,
                    correctAnswers: 0,
                    tilesLandedOn: 0,
                    exerciseCompleted: 0
                });
            }
            
            // Initialize players
            gameState.players = players;
            
            // Generate new random seed for board layout
            gameState.lastRandomSeed = Date.now();
            
            // Initialize tiles with random layout
            generateTiles();
            
            // Adjust tile type probabilities based on board size
            adjustTileProbabilities();
            
            // Calculate dynamic rewards based on board size
            calculateDynamicRewards();
            
            // Render game board
            renderBoard();
            
            // Render player info
            renderPlayerInfo();
            
            // Hide start screen, show game
            if (startScreen) {
                startScreen.style.opacity = '0';
                startScreen.style.pointerEvents = 'none';
                setTimeout(() => {
                    startScreen.style.display = 'none';
                    startScreen.style.opacity = '1';
                }, 300);
            }
            
            gameState.gameActive = true;
            gameState.isRolling = false;
            
            // Reset roll button state
            if (rollBtn) {
                rollBtn.disabled = false;
                rollBtn.style.opacity = '1';
            }
            
            // Set first player as active
            updateCurrentPlayerDisplay();
            
            // Show initial turn message
            showTurnMessage(`${gameState.players[0].name}'s turn to start! Click "Roll & Move!" to begin.`, 5000);
        }
        
        function calculateDynamicRewards() {
            // Make rewards scale with board size
            const baseExtra = Math.max(2, Math.floor(currentTileCount / 15));
            const basePenalty = Math.max(-2, -Math.floor(currentTileCount / 20));
            
            CONFIG.extraMoveReward = baseExtra;
            CONFIG.penaltyMove = basePenalty;
        }
        
        function adjustTileProbabilities() {
            const tileCount = currentTileCount;
            
            // Adjust probabilities based on board size
            if (tileCount <= 30) {
                TILE_TYPES.QUESTION.probability = 0.35;
                TILE_TYPES.EXERCISE.probability = 0.15;
                TILE_TYPES.FACT.probability = 0.2;
                TILE_TYPES.EMPTY.probability = 0.3;
            } else if (tileCount <= 45) {
                TILE_TYPES.QUESTION.probability = 0.3;
                TILE_TYPES.EXERCISE.probability = 0.2;
                TILE_TYPES.FACT.probability = 0.25;
                TILE_TYPES.EMPTY.probability = 0.25;
            } else {
                TILE_TYPES.QUESTION.probability = 0.25;
                TILE_TYPES.EXERCISE.probability = 0.25;
                TILE_TYPES.FACT.probability = 0.3;
                TILE_TYPES.EMPTY.probability = 0.2;
            }
        }
        
        function generateTiles() {
            gameState.tiles = [];
            
            // Create start tile
            gameState.tiles.push({
                number: 0,
                type: 'start',
                name: 'Start',
                emoji: 'üöÄ',
                colorClass: 'tile-start',
                description: 'Begin your nutrition adventure here!'
            });
            
            // Use random seed for consistent random generation
            const seed = gameState.lastRandomSeed;
            let randomIndex = 0;
            
            // Create middle tiles with random types based on probabilities
            for (let i = 1; i < currentTileCount - 1; i++) {
                // Use seeded random for consistent board generation
                randomIndex++;
                const randomValue = Math.sin(seed + i * 100 + randomIndex) * 10000;
                const rand = Math.abs(randomValue - Math.floor(randomValue));
                
                let tileType;
                let accumulated = 0;
                
                // Check each tile type in order of probability
                const types = [TILE_TYPES.QUESTION, TILE_TYPES.EXERCISE, TILE_TYPES.FACT, TILE_TYPES.EMPTY];
                const probabilities = [TILE_TYPES.QUESTION.probability, TILE_TYPES.EXERCISE.probability, 
                                      TILE_TYPES.FACT.probability, TILE_TYPES.EMPTY.probability];
                
                for (let j = 0; j < types.length; j++) {
                    accumulated += probabilities[j];
                    if (rand < accumulated) {
                        tileType = types[j];
                        break;
                    }
                }
                
                // Add some random variation
                if (i % 7 === 0 && rand > 0.5) {
                    tileType = TILE_TYPES.FACT;
                } else if (i % 5 === 0 && rand < 0.3) {
                    tileType = TILE_TYPES.EXERCISE;
                }
                
                // Ensure tile type exists
                if (!tileType) {
                    tileType = TILE_TYPES.EMPTY;
                }
                
                gameState.tiles.push({
                    number: i,
                    type: tileType.name,
                    name: tileType.name,
                    emoji: tileType.emoji,
                    colorClass: tileType.color,
                    description: tileType.description
                });
            }
            
            // Create finish tile
            gameState.tiles.push({
                number: currentTileCount - 1,
                type: 'finish',
                name: 'Finish',
                emoji: 'üèÜ',
                colorClass: 'tile-finish',
                description: 'Complete your nutrition journey! First player to reach here wins!'
            });
        }
        
        function renderBoard() {
            if (!boardPath) return;
            
            boardPath.innerHTML = '';
            gameState.tiles.forEach((tile, i) => {
                const tileElement = document.createElement('div');
                tileElement.className = `tile ${tile.colorClass}`;
                tileElement.setAttribute('data-index', i);
                
                // Create tooltip element
                const tooltip = document.createElement('div');
                tooltip.className = 'tile-tooltip';
                tooltip.textContent = tile.description;
                
                tileElement.innerHTML = `
                    <div class="tile-number">${i + 1}</div>
                    <div class="tile-icon">${tile.emoji}</div>
                    <div class="tile-name">${tile.name}</div>
                `;
                
                tileElement.appendChild(tooltip);
                boardPath.appendChild(tileElement);
            });
            
            updatePlayerPositions();
        }
        
        function updatePlayerPositions() {
            if (!boardPath) return;
            
            // Remove existing tokens
            document.querySelectorAll('.player-token').forEach(token => token.remove());
            
            // Group players by tile position
            const playersByTile = {};
            gameState.players.forEach(player => {
                if (!playersByTile[player.position]) {
                    playersByTile[player.position] = [];
                }
                playersByTile[player.position].push(player);
            });
            
            // Add tokens for each player on each tile
            Object.keys(playersByTile).forEach(tilePos => {
                const playersOnTile = playersByTile[tilePos];
                const tileElement = boardPath.children[tilePos];
                
                if (tileElement) {
                    playersOnTile.forEach((player, index) => {
                        const token = document.createElement('div');
                        token.className = `player-token ${player.colorClass}`;
                        token.textContent = player.id;
                        token.style.color = player.textColor;
                        token.style.backgroundColor = player.colorValue;
                        token.title = `${player.name} (Score: ${player.score})`;
                        
                        // Assign different corners based on player position index
                        const positionIndex = index % TOKEN_POSITIONS.length;
                        Object.assign(token.style, TOKEN_POSITIONS[positionIndex]);
                        
                        tileElement.appendChild(token);
                    });
                }
            });
        }
        
        function renderPlayerInfo() {
            if (!playersContainer) return;
            
            playersContainer.innerHTML = '';
            
            gameState.players.forEach((player, index) => {
                const playerCard = document.createElement('div');
                playerCard.className = `player-card ${player.colorClass} ${index === gameState.currentPlayerIndex ? 'active' : ''}`;
                playerCard.style.cssText = `
                    background: ${player.colorValue};
                    color: ${player.textColor};
                    text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
                `;
                playerCard.innerHTML = `
                    <div class="player-name">${player.name}</div>
                    <div class="player-score">${player.score}</div>
                    <div style="font-size: 0.8rem; opacity: 0.9;">Tile: ${player.position + 1}</div>
                `;
                playersContainer.appendChild(playerCard);
            });
        }
        
        function updateCurrentPlayerDisplay() {
            if (!rollBtn || !playersContainer) return;
            
            // Update player cards
            document.querySelectorAll('.player-card').forEach((card, index) => {
                if (index === gameState.currentPlayerIndex) {
                    card.classList.add('active');
                } else {
                    card.classList.remove('active');
                }
            });
            
            // Update roll button text
            const currentPlayer = gameState.players[gameState.currentPlayerIndex];
            rollBtn.innerHTML = `<i class="fas fa-dice"></i> ${currentPlayer.name}'s Turn - Roll & Move!`;
        }
        
        function showTurnMessage(message, duration = 4000) {
            if (!turnMessage) return;
            
            // Clear any existing timeout
            if (notificationTimeout) {
                clearTimeout(notificationTimeout);
                turnMessage.classList.remove('fade-out');
            }
            
            turnMessage.textContent = message;
            turnMessage.style.display = 'block';
            turnMessage.style.opacity = '1';
            
            // Set timeout to fade out
            notificationTimeout = setTimeout(() => {
                turnMessage.classList.add('fade-out');
                
                // Remove from DOM after fade out
                setTimeout(() => {
                    if (turnMessage.classList.contains('fade-out')) {
                        turnMessage.style.display = 'none';
                        turnMessage.classList.remove('fade-out');
                    }
                }, 1000);
            }, duration);
        }
        
        // ============================================
        // GAME LOGIC
        // ============================================
        
        function rollDice() {
            if (!gameState.gameActive || gameState.questionActive || gameState.isRolling) {
                return;
            }
            
            gameState.isRolling = true;
            if (rollBtn) rollBtn.disabled = true;
            
            // Generate random dice value
            gameState.diceValue = Math.floor(Math.random() * CONFIG.diceSides) + 1;
            
            // Show dice result with animation
            if (diceResult) {
                diceResult.style.display = 'block';
                diceResult.textContent = `üé≤ ${gameState.diceValue}`;
            }
            
            const currentPlayer = gameState.players[gameState.currentPlayerIndex];
            showTurnMessage(`${currentPlayer.name} rolled a ${gameState.diceValue}!`);
            
            // Move player with animation
            setTimeout(() => {
                animateMovement(gameState.diceValue);
            }, 1000);
        }
        
        function animateMovement(spaces) {
            const currentPlayer = gameState.players[gameState.currentPlayerIndex];
            const startPosition = currentPlayer.position;
            const targetPosition = Math.min(startPosition + spaces, CONFIG.finishTile);
            
            // Track tiles landed on
            currentPlayer.tilesLandedOn += spaces;
            
            let currentStep = 0;
            const stepDelay = 300; // ms between steps
            
            function moveStep() {
                if (currentStep < spaces && currentPlayer.position < CONFIG.finishTile) {
                    currentPlayer.position = startPosition + currentStep + 1;
                    updatePlayerPositions();
                    currentStep++;
                    setTimeout(moveStep, stepDelay);
                } else {
                    // Animation complete
                    updatePlayerPositions();
                    renderPlayerInfo();
                    
                    // Check for win condition
                    if (currentPlayer.position === CONFIG.finishTile) {
                        setTimeout(() => endGame(currentPlayer), 800);
                        return;
                    }
                    
                    // Check tile action after animation
                    setTimeout(() => {
                        checkTileAction(currentPlayer.position);
                    }, 500);
                }
            }
            
            moveStep();
        }
        
        function checkTileAction(tileIndex) {
            const tile = gameState.tiles[tileIndex];
            const currentPlayer = gameState.players[gameState.currentPlayerIndex];
            
            // Skip action for start and finish tiles
            if (tile.type === 'start' || tile.type === 'finish') {
                endTurn();
                return;
            }
            
            // Handle empty tiles
            if (tile.type === 'rest') {
                showTurnMessage(`${currentPlayer.name} landed on a rest space. Time to relax! üçÉ`, 3000);
                setTimeout(() => endTurn(), 1500);
                return;
            }
            
            gameState.questionActive = true;
            if (questionPanel) questionPanel.classList.add('active');
            if (feedback) feedback.classList.remove('show');
            
            // Handle different tile types
            switch (tile.type) {
                case 'Question':
                    showQuestion();
                    break;
                case 'Exercise':
                    showExerciseChallenge();
                    break;
                case 'Fact':
                    showFact();
                    break;
                default:
                    endTurn();
            }
        }
        
        function showQuestion() {
            // Make sure external data is loaded
            if (!externalDataLoaded) {
                showFeedback("Game data still loading. Please try again.", false);
                setTimeout(() => endTurn(), 1500);
                return;
            }
            
            const questions = window.QUESTIONS;
            if (!questions || questions.length === 0) {
                console.error("No questions available!");
                showFeedback("No questions available. Please check the data file.", false);
                setTimeout(() => endTurn(), 1500);
                return;
            }
            
            const randomIndex = Math.floor(Math.random() * questions.length);
            const question = questions[randomIndex];
            
            // Update question panel
            if (questionIcon) questionIcon.textContent = question.icon || "‚ùì";
            if (questionType) questionType.textContent = "Nutrition Question";
            if (questionText) questionText.textContent = question.question;
            
            // Clear and add options
            if (optionsContainer) {
                optionsContainer.innerHTML = '';
                question.options.forEach((option, index) => {
                    const optionBtn = document.createElement('button');
                    optionBtn.className = 'option-btn';
                    optionBtn.textContent = option;
                    optionBtn.addEventListener('click', () => checkAnswer(index, question));
                    optionsContainer.appendChild(optionBtn);
                });
            }
        }
        
        function showExerciseChallenge() {
            // Make sure external data is loaded
            if (!externalDataLoaded) {
                showFeedback("Game data still loading. Please try again.", false);
                setTimeout(() => endTurn(), 1500);
                return;
            }
            
            const exercises = window.EXERCISE_CHALLENGES;
            if (!exercises || exercises.length === 0) {
                console.error("No exercise challenges available!");
                showFeedback("No exercise challenges available. Please check the data file.", false);
                setTimeout(() => endTurn(), 1500);
                return;
            }
            
            const randomIndex = Math.floor(Math.random() * exercises.length);
            const challenge = exercises[randomIndex];
            
            if (questionIcon) questionIcon.textContent = "üèÉ";
            if (questionType) questionType.textContent = "Exercise Challenge";
            if (questionText) questionText.textContent = challenge;
            
            if (optionsContainer) {
                optionsContainer.innerHTML = `
                    <button class="option-btn" id="completeExercise">I did it! Feeling energized!</button>
                `;
                
                document.getElementById('completeExercise').addEventListener('click', () => {
                    const currentPlayer = gameState.players[gameState.currentPlayerIndex];
                    currentPlayer.score += 3;
                    currentPlayer.exerciseCompleted += 1;
                    
                    showFeedback("Awesome! Exercise keeps your body and mind healthy! üí™", true);
                    setTimeout(() => {
                        giveReward(CONFIG.extraMoveReward);
                    }, 1500);
                });
            }
        }
        
        function showFact() {
            // Make sure external data is loaded
            if (!externalDataLoaded) {
                showFeedback("Game data still loading. Please try again.", false);
                setTimeout(() => endTurn(), 1500);
                return;
            }
            
            const facts = window.FACTS;
            if (!facts || facts.length === 0) {
                console.error("No facts available!");
                showFeedback("No facts available. Please check the data file.", false);
                setTimeout(() => endTurn(), 1500);
                return;
            }
            
            const randomIndex = Math.floor(Math.random() * facts.length);
            const fact = facts[randomIndex];
            
            if (questionIcon) questionIcon.textContent = "üí°";
            if (questionType) questionType.textContent = "Healthy Fact";
            if (questionText) questionText.textContent = fact;
            
            if (optionsContainer) {
                optionsContainer.innerHTML = `
                    <button class="option-btn" id="learnedFact">I learned something new!</button>
                `;
                
                document.getElementById('learnedFact').addEventListener('click', () => {
                    const currentPlayer = gameState.players[gameState.currentPlayerIndex];
                    currentPlayer.score += 2;
                    
                    showFeedback("Learning about health is a superpower! üß†", true);
                    setTimeout(() => {
                        endTurn();
                    }, 1500);
                });
            }
        }
        
        function checkAnswer(selectedIndex, question) {
            const currentPlayer = gameState.players[gameState.currentPlayerIndex];
            const isCorrect = selectedIndex === question.correct;
            
            // Update player stats
            currentPlayer.questionsAnswered += 1;
            if (isCorrect) currentPlayer.correctAnswers += 1;
            
            // Disable all buttons
            document.querySelectorAll('.option-btn').forEach(btn => {
                btn.disabled = true;
                if (btn.textContent === question.options[selectedIndex]) {
                    btn.classList.add(isCorrect ? 'correct' : 'incorrect');
                }
                if (btn.textContent === question.options[question.correct]) {
                    btn.classList.add('correct');
                }
            });
            
            // Show feedback
            if (isCorrect) {
                currentPlayer.score += 10;
                showFeedback(question.feedback, true);
                showTurnMessage(`Correct! ${currentPlayer.name} earned 10 points!`, 3000);
                setTimeout(() => {
                    giveReward(CONFIG.extraMoveReward);
                }, 1500);
            } else {
                currentPlayer.score += 1; // Give 1 point for trying
                showFeedback(`Good try! The correct answer was: ${question.options[question.correct]}. ${question.feedback}`, false);
                showTurnMessage(`${currentPlayer.name} gets 1 point for trying!`, 3000);
                setTimeout(() => {
                    givePenalty(CONFIG.penaltyMove);
                }, 1500);
            }
            
            // Update player display
            renderPlayerInfo();
        }
        
        function showFeedback(message, isPositive) {
            if (!feedback) return;
            
            feedback.textContent = message;
            feedback.style.borderLeftColor = isPositive ? 'var(--primary)' : 'var(--danger)';
            feedback.classList.add('show');
        }
        
        function giveReward(extraMoves) {
            hideQuestionPanel();
            showTurnMessage(`Great job! You get ${extraMoves} extra move${extraMoves > 1 ? 's' : ''}!`, 3000);
            setTimeout(() => {
                animateMovement(extraMoves);
            }, 1000);
        }
        
        function givePenalty(penaltyMoves) {
            hideQuestionPanel();
            if (penaltyMoves < 0) {
                showTurnMessage(`Move back ${Math.abs(penaltyMoves)} space${Math.abs(penaltyMoves) > 1 ? 's' : ''}. Don't worry, you'll get the next one!`, 3000);
                setTimeout(() => {
                    animateMovement(penaltyMoves);
                }, 1000);
            } else {
                endTurn();
            }
        }
        
        function hideQuestionPanel() {
            if (questionPanel) questionPanel.classList.remove('active');
            gameState.questionActive = false;
        }
        
        function endTurn() {
            hideQuestionPanel();
            gameState.isRolling = false;
            if (rollBtn) rollBtn.disabled = false;
            
            if (diceResult) diceResult.style.display = 'none';
            
            // Move to next player
            gameState.currentPlayerIndex = (gameState.currentPlayerIndex + 1) % gameState.players.length;
            updateCurrentPlayerDisplay();
            
            const nextPlayer = gameState.players[gameState.currentPlayerIndex];
            showTurnMessage(`${nextPlayer.name}'s turn! Click "Roll & Move!" to play.`, 4000);
        }
        
        function endGame(winner) {
            gameState.gameActive = false;
            gameState.isRolling = false;
            if (rollBtn) rollBtn.disabled = false;
            
            // Show win screen
            if (winnerMessage) winnerMessage.textContent = `${winner.name} wins! üéâ`;
            
            // Random nutrition message
            if (nutritionMessage) {
                const winMessages = window.WIN_MESSAGES || [
                    "Congratulations on completing your nutrition adventure!",
                    "Great job! Remember to eat a rainbow of fruits and vegetables every day!",
                    "You're a nutrition champion! Keep making healthy choices!"
                ];
                const randomMessageIndex = Math.floor(Math.random() * winMessages.length);
                nutritionMessage.textContent = winMessages[randomMessageIndex];
            }
            
            // Create leaderboard
            createLeaderboard();
            
            if (winScreen) {
                winScreen.style.display = 'flex';
                setTimeout(() => {
                    winScreen.style.opacity = '1';
                }, 10);
            }
            showTurnMessage(`Congratulations ${winner.name}! You won the game! üèÜ`, 6000);
        }
        
        function createLeaderboard() {
            if (!statsContainer) return;
            
            statsContainer.innerHTML = '';
            
            gameState.players.forEach(player => {
                const accuracy = player.questionsAnswered > 0 
                    ? Math.round((player.correctAnswers / player.questionsAnswered) * 100) 
                    : 0;
                
                const statsHTML = `
                    <div class="stat-card" style="border-left-color: ${player.colorValue}">
                        <h4>${player.name}</h4>
                        <div class="stat-value">${player.score}</div>
                        <p>Final Score</p>
                        <div style="margin-top: 8px; font-size: 0.9rem;">
                            <div>Questions: ${player.correctAnswers}/${player.questionsAnswered}</div>
                            <div>Accuracy: ${accuracy}%</div>
                            <div>Exercises: ${player.exerciseCompleted}</div>
                        </div>
                    </div>
                `;
                
                statsContainer.innerHTML += statsHTML;
            });
            
            createScoreChart();
        }
        
        function createScoreChart() {
            const ctx = document.getElementById('scoreChart');
            if (!ctx) return;
            
            const context = ctx.getContext('2d');
            
            const playerNames = gameState.players.map(p => p.name);
            const playerScores = gameState.players.map(p => p.score);
            const playerColors = gameState.players.map(p => p.colorValue);
            
            if (window.scoreChartInstance) {
                window.scoreChartInstance.destroy();
            }
            
            window.scoreChartInstance = new Chart(context, {
                type: 'bar',
                data: {
                    labels: playerNames,
                    datasets: [{
                        label: 'Final Scores',
                        data: playerScores,
                        backgroundColor: playerColors,
                        borderColor: playerColors,
                        borderWidth: 2,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        title: {
                            display: true,
                            text: 'Player Scores',
                            font: { size: 18, family: "'Fredoka One', 'Segoe UI', sans-serif" },
                            color: '#333'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                font: { family: "'Comic Neue', 'Comic Sans MS', cursive, sans-serif", size: 12 }
                            }
                        },
                        x: {
                            ticks: {
                                font: { family: "'Comic Neue', 'Comic Sans MS', cursive, sans-serif", size: 12 }
                            }
                        }
                    }
                }
            });
        }
        
        function resetGame() {
            // Hide win screen with animation
            if (winScreen) {
                winScreen.style.opacity = '0';
                setTimeout(() => {
                    winScreen.style.display = 'none';
                    winScreen.style.opacity = '1';
                }, 300);
            }
            
            // Show start screen with animation
            if (startScreen) {
                startScreen.style.display = 'flex';
                startScreen.style.pointerEvents = 'auto';
                setTimeout(() => {
                    startScreen.style.opacity = '1';
                }, 10);
            }
            
            // Reset game state
            gameState = {
                players: [],
                currentPlayerIndex: 0,
                gameActive: false,
                tiles: [],
                diceValue: 0,
                questionActive: false,
                isRolling: false,
                lastRandomSeed: Date.now()
            };
            
            // Reset displays
            if (diceResult) diceResult.style.display = 'none';
            if (questionPanel) questionPanel.classList.remove('active');
            if (turnMessage) {
                turnMessage.style.display = 'none';
                turnMessage.classList.remove('fade-out');
            }
            if (boardPath) boardPath.innerHTML = '';
            if (playersContainer) playersContainer.innerHTML = '';
            if (rollBtn) {
                rollBtn.disabled = false;
                rollBtn.innerHTML = `<i class="fas fa-dice"></i> Roll & Move!`;
            }
            
            // Clear notification timeout
            if (notificationTimeout) {
                clearTimeout(notificationTimeout);
                notificationTimeout = null;
            }
            
            // Re-initialize configuration
            currentPlayerCount = 2;
            currentTileCount = 30;
            updatePlayerCountDisplay();
            updateTileCountDisplay();
            renderPlayerInputs();
            updateConfigurationButtons();
            
            // Reset preset buttons
            document.querySelectorAll('.preset-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.tiles === "30");
            });
            
            console.log("Game reset successfully!");
        }
        
        // ============================================
        // INITIALIZE GAME
        // ============================================
        
        document.addEventListener('DOMContentLoaded', function() {
            // Get DOM elements
            startScreen = document.getElementById('startScreen');
            winScreen = document.getElementById('winScreen');
            gameBoard = document.getElementById('gameBoard');
            boardPath = document.getElementById('boardPath');
            playersContainer = document.getElementById('playersContainer');
            diceResult = document.getElementById('diceResult');
            questionPanel = document.getElementById('questionPanel');
            questionText = document.getElementById('questionText');
            questionIcon = document.getElementById('questionIcon');
            questionType = document.getElementById('questionType');
            optionsContainer = document.getElementById('optionsContainer');
            feedback = document.getElementById('feedback');
            rollBtn = document.getElementById('rollBtn');
            newGameBtn = document.getElementById('newGameBtn');
            startGameBtn = document.getElementById('startGameBtn');
            playAgainBtn = document.getElementById('playAgainBtn');
            winnerMessage = document.getElementById('winnerMessage');
            nutritionMessage = document.getElementById('nutritionMessage');
            statsContainer = document.getElementById('statsContainer');
            turnMessage = document.getElementById('turnMessage');
            loadingScreen = document.getElementById('loadingScreen');
            
            // Show loading screen immediately
            showLoadingScreen();
            
            // Start loading external data
            setTimeout(() => {
                loadExternalData();
            }, 500);
            
            // Create music elements
            createMusicElements();
            
            // Initialize configuration after data loads
            setTimeout(() => {
                initializeConfiguration();
            }, 1000);
            
            // Set up event listeners
            if (startGameBtn) {
                startGameBtn.addEventListener('click', function() {
                    initGame();
                });
            }
            
            if (playAgainBtn) {
                playAgainBtn.addEventListener('click', function() {
                    resetGame();
                });
            }
            
            if (rollBtn) {
                rollBtn.addEventListener('click', function() {
                    rollDice();
                });
            }
            
            if (newGameBtn) {
                newGameBtn.addEventListener('click', function() {
                    resetGame();
                });
            }
            
            // Display win screen as hidden initially
            if (winScreen) winScreen.style.display = 'none';
            
            // Log initialization
            console.log("Game initialized successfully!");
        });
    </script>
</body>
</html>